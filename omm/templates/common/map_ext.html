{% extends 'common/map.html' %}

{% block layersConfig %}
    // setup which kml files are shown in the data layers panel
    lingcod.addLayer('{% url studyregion-kml %}', {setExtent: true});
    lingcod.addLayer('{% url public-data-layers %}');   
    lingcod.addLayer("{% url public-fishing-data-layers %}");        
    {% if user.is_authenticated %}
        lingcod.addLayer('{% url private-data-layers session_key=session_key %}');            
    {% endif %}
{% endblock layersConfig %}

{% block tabs %}
    {% if user.is_authenticated %}
    <li><a href="#MyShapes"><span>My Shapes</span></a></li>                
    {% endif %}
    <li><a href="#SharedShapes"><span>{% if user.is_authenticated %}Shared With Me{% else %}Areas of Interest{% endif %}</span></a></li>
{% endblock tabs %}

{% block metanavigation %}
    {% if user.is_authenticated %}
    <li>{{user.username}} | </li>
    {% endif %}
    <li><a href="#" id="news">news</a> | </li>
    <li><a href="#" id="about">about marinemap</a> | </li>
    {% block meta_navigation_list_insert %}{% endblock %}
    <li><a href="{% url help-main %}" target="_blank" id="help">help</a> | </li>
    {% if user.is_authenticated %}
    <li><a href="{% url user_profile-form user.username %}">my profile</a> | </li>
    <li><a href="{% url auth_logout %}">sign out</a></li>
    {% else %}
    <li><a href="{% url registration_register %}">register</a> | </li>
    <li><a href="{% url auth_login %}">sign in</a></li>
    {% endif %}                
{% endblock metanavigation %}


{% block shapeDefinitionPanelManipulators %}
<div class="manipulators" style="display:none;">
    <h3>Optionally exclude any of the following regions from your Area of Inquiry</h3>
    {#  These divs get populated in media/manipulators/js/manipulators.js #}
    <div class="requiredManipulators"> </div>
    <div class="optionalManipulators"> </div>
    <hr />
</div>
{% endblock shapeDefinitionPanelManipulators %}


{% block shapeDefinitionPanelBeforeManipulatorContent %}   
The following clipping operations were performed on your shape:                 
{% endblock shapeDefinitionPanelBeforeManipulatorContent %}

{% block shapeDefinitionPanelAfterManipulatorContent %}     
If you ever need to change your shape, we also keep a copy of the lines you draw, so you will always have the un-clipped version for editing.
<br><br>
{% endblock shapeDefinitionPanelAfterManipulatorContent %}

{% block myshapes %}
    var add_to_array = "{% url array-add-mpa 999999999999999 %}";
    var remove_mpa = "{% url array-remove-mpa 999999999999999 %}"
    var getId = function(node, editor){
        var kmlObject;
        kmlObject = editor.tree.getNetworkLink(node);
        if(!kmlObject){
            kmlObject = editor.tree.lookup(node);
        }
        return kmldom(kmlObject.getKml()).find('[nodeName=atom:link][rel=self]').attr('mm:pk');
    };
    
    var getLocation = function(node, editor){
        var kmlObject;
        kmlObject = editor.tree.getNetworkLink(node);
        if(!kmlObject){
            kmlObject = editor.tree.lookup(node);
        }
        var self = kmldom(kmlObject.getKml()).find('[nodeName=atom:link][rel=self]');
        return self.attr('href');
    }
    
    var dragDropCallback = function(array_location, mpa_location, editor){
        editor.refresh(function(){
            if(array_location){
                var array_node = editor.tree.getNodesById(array_location);
                if(array_node.hasClass('loaded')){
                    var mpa_node = editor.tree.getNodesById(mpa_location);
                    editor.tree.selectNode(
                        mpa_node, 
                        editor.tree.lookup(mpa_node)
                    );
                }else{
                    $(array_node).bind('loaded', function(e, node, kmlObject){
                        var mpa_node = editor.tree.getNodesById(mpa_location);
                        editor.tree.selectNode(
                            mpa_node, 
                            editor.tree.lookup(mpa_node)
                        );
                    });
                    editor.tree.openNetworkLink(array_node);
                }
            }else{
                var node = editor.tree.getNodesById(mpa_location);
                editor.tree.selectNode(node, editor.tree.lookup(node));                
            }
        });
    }
    
    var setupDragDrop = function(editor, list, kmlObject){
        $(editor.tree).bind('networklinkload', function(e, node, kmlObject){
            enableDragDrop(editor, node, kmlObject);
        });
        enableDragDrop(editor, list, kmlObject);
    }
    
    var enableDragDrop = function(editor, list, kmlObject){
        list.find('li.tsp_aoi').draggable({scope:'tsp_aoi', containment: editor.el, scroll:true, revert:'invalid', handle: 'span.name, span.icon', delay: 150, scroll: true});
        list.find('li.tsp_aoiarray').droppable({scope:'tsp_aoi', activeClass: '.ui-state-highlight', hoverClass: 'drophover', tolerance: 'pointer', drop: function(event, ui){
            var array = event.target;
            var array_pk = getId(array, editor);
            var mpa = ui.draggable[0];
            var mpa_pk = getId(mpa, editor);
            if($(mpa).parent().parent()[0] === array){
                $(mpa).css({left: 0, top: 0});
                return false;
            }
            array_location = getLocation(array, editor);
            mpa_location = getLocation(mpa, editor);
            editor.el.find('li.tsp_aoiarray').droppable('destroy');
            $.ajax({
                type: 'POST',
                url: add_to_array.replace('999999999999999', array_pk),
                data: {mpa_id: mpa_pk},
                success: function(){
                    dragDropCallback(array_location, mpa_location, editor);
                },
                error: function(){
                    alert('could not assign mpa to array due to a server error.');
                    editor.refresh();
                }
            });
        }});
        
        editor.el.find('li span.name:contains(Marine Protected Areas)').parent().droppable({scope:'tsp_aoi', activeClass: '.ui-state-highlight', hoverClass: 'drophover', tolerance: 'pointer', drop: function(event, ui){
            // var array = event.target;
            // var array_pk = getId(array, editor);
            var mpa = ui.draggable[0];
            var mpa_pk = getId(mpa, editor);
            if($(mpa).parent().parent()[0] === this){
                $(mpa).css({left: 0, top: 0});
                return false;
            }
            var mpa_location = getLocation($(mpa), editor);
            var array_pk = getId($(mpa).parent().parent(), editor);            
            editor.el.find('li.tsp_aoiarray').droppable('destroy');
            $(this).droppable('destroy');
            $.ajax({
                type: 'POST',
                url: remove_mpa.replace('999999999999999', array_pk),
                data: {mpa_id: mpa_pk},
                success: function(){
                    dragDropCallback(null, mpa_location, editor);
                },
                error: function(){
                    alert('could not remove mpa from array due to a server error.');
                    editor.refresh();
                }
            });
        }});
        
    };
    {% if user.is_authenticated %}
        options.myshapes = [{url: "{% url kmlapp-userlinks-kmz input_username=user.username session_key=session_key %}", callback: setupDragDrop}];
    {% endif %}
{% endblock myshapes %}
